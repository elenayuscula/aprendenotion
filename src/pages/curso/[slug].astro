---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import NotionRenderer from '../../components/notion/NotionRenderer.astro';
import YouTubeEmbed from '../../components/YouTubeEmbed.astro';
import { getBlocks } from '../../lib/notion';
import type { BlockObjectResponse } from '@notionhq/client/build/src/api-endpoints';

// Videos de cada lección — extraídos de las páginas estáticas originales
// Estos videos no están en Notion porque el MCP no soporta bloques de tipo video.
// Cuando un video va al principio de la lección, se usa "top". Para posiciones
// intermedias se indica el heading después del cual va el video.
const LESSON_VIDEOS: Record<string, { id: string; position: 'top' | string }[]> = {
  'introduccion-espacio-trabajo': [
    { id: 'jjXOaNAL8gw', position: 'top' },
  ],
  'paginas-bloques': [
    { id: 'QnnKfqFNkTY', position: 'top' },
    { id: 'LM4XGuMEpRA', position: 'Dándole estilo al texto' },
    { id: 'ATYQVCoxxf4', position: 'Bloques básicos' },
    { id: 'jn0LMMD3y68', position: 'Los bloques son fluidos' },
    { id: 'VVz6AwlX9Ug', position: 'Páginas y subpáginas' },
  ],
  'introduccion-bases-datos': [
    { id: 'FCn92JBS3Dk', position: 'top' },
  ],
  'filtros-ordenacion': [
    { id: 'NtDPmBjCxR8', position: 'top' },
  ],
  'vistas-bases-datos': [
    { id: '4o6mJNhXuMk', position: 'top' },
  ],
  'templates': [
    { id: 'a3HjQhB0UVI', position: 'top' },
  ],
  'nuevas-bases-de-datos': [
    { id: 'e_rd_MWQ-6s', position: 'top' },
  ],
  'relations': [
    { id: 'FBCc7EUTKik', position: 'top' },
    { id: 'PmPDB5BnnOE', position: 'Las páginas relacionadas' },
  ],
  'rollups': [
    { id: 'e6Re1I0p46I', position: 'top' },
  ],
  'introduccion-formulas': [
    { id: '6FLHs29zsUM', position: 'top' },
  ],
  'formulas-avanzadas': [
    { id: 'kx8Ciyu7jzk', position: 'top' },
  ],
  'barras-de-progreso-notion': [
    { id: 'gNcAJhuLrZU', position: 'top' },
  ],
};

export async function getStaticPaths() {
  const lessons = await getCollection('lessons');
  const sorted = lessons.sort((a, b) => a.data.order - b.data.order);

  return sorted.map((lesson, index) => ({
    params: { slug: lesson.id },
    props: {
      lesson,
      prev: index > 0 ? sorted[index - 1] : null,
      next: index < sorted.length - 1 ? sorted[index + 1] : null,
    },
  }));
}

const { lesson, prev, next } = Astro.props;

// Fetch Notion blocks
let blocks: BlockObjectResponse[] = [];
if (lesson.data.notionId) {
  blocks = await getBlocks(lesson.data.notionId);
}

// Get videos for this lesson
const lessonVideos = LESSON_VIDEOS[lesson.id] || [];
const topVideos = lessonVideos.filter(v => v.position === 'top');
const midVideos = lessonVideos.filter(v => v.position !== 'top');

// Build a map of heading text → videos to insert after that section
const midVideoMap = new Map<string, string[]>();
for (const v of midVideos) {
  const key = v.position.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  if (!midVideoMap.has(key)) midVideoMap.set(key, []);
  midVideoMap.get(key)!.push(v.id);
}

// Helper to normalize heading text for matching
function normalizeText(text: string): string {
  return text.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim();
}

// Extract heading text from a block
function getHeadingText(block: any): string | null {
  const types = ['heading_1', 'heading_2', 'heading_3'];
  for (const t of types) {
    if (block.type === t && block[t]?.rich_text) {
      return block[t].rich_text.map((rt: any) => rt.plain_text).join('');
    }
  }
  return null;
}
---

<BaseLayout
  title={`${lesson.data.title} — Curso de Notion`}
  description={lesson.data.description}
>
  <article class="page-wrapper">
    <!-- Lesson header -->
    <header class="lesson-header">
      <a href="/curso" class="lesson-header__back">← Volver al curso</a>
      <div class="lesson-header__meta">
        <span class="lesson-header__module">{lesson.data.module}</span>
        <span class="lesson-header__separator">·</span>
        <span class="lesson-header__number">Lección {lesson.data.order}</span>
      </div>
      <h1 class="lesson-header__title">
        <span class="lesson-header__emoji" aria-hidden="true">{lesson.data.emoji}</span>
        {lesson.data.title}
      </h1>
      {lesson.data.description && (
        <p class="lesson-header__description">{lesson.data.description}</p>
      )}
    </header>

    <hr />

    <!-- Lesson content -->
    <div class="blog-post-content content">
      {blocks.length > 0 ? (
        <>
          {/* Videos at top of lesson */}
          {topVideos.map(v => (
            <YouTubeEmbed videoId={v.id} title={lesson.data.title} />
          ))}

          {/* Render blocks, injecting mid-content videos after matching headings */}
          {blocks.map((block) => {
            const headingText = getHeadingText(block);
            const normalized = headingText ? normalizeText(headingText) : null;
            const videosAfter = normalized ? midVideoMap.get(normalized) : null;

            return (
              <>
                <NotionRenderer blocks={[block]} />
                {videosAfter && videosAfter.map(vid => (
                  <YouTubeEmbed videoId={vid} title={headingText || lesson.data.title} />
                ))}
              </>
            );
          })}
        </>
      ) : (
        <p class="notion-empty-state">Esta lección está en preparación. Vuelve pronto.</p>
      )}
    </div>

    <!-- Prev/Next navigation -->
    <nav class="page-nav" aria-label="Navegación de lecciones">
      {prev ? (
        <a href={`/curso/${prev.id}`} class="page-nav__link">← {prev.data.title}</a>
      ) : (
        <span class="page-nav__link page-nav__link--disabled"></span>
      )}
      {next ? (
        <a href={`/curso/${next.id}`} class="page-nav__link page-nav__link--next">{next.data.title} →</a>
      ) : (
        <span class="page-nav__link page-nav__link--disabled"></span>
      )}
    </nav>
  </article>
</BaseLayout>

<style>
  .lesson-header {
    margin-bottom: var(--space-8);
  }
  .lesson-header__back {
    display: inline-block;
    font-size: 0.85rem;
    color: var(--color-text-secondary, #6B6B6B);
    text-decoration: none;
    margin-bottom: var(--space-6);
  }
  .lesson-header__back:hover {
    color: var(--color-accent, #6C7D07);
  }
  .lesson-header__meta {
    display: flex;
    align-items: center;
    gap: 0.5em;
    font-size: 0.85rem;
    color: var(--color-text-secondary, #6B6B6B);
    margin-bottom: var(--space-3);
  }
  .lesson-header__module {
    font-weight: 600;
    color: var(--color-accent, #6C7D07);
  }
  .lesson-header__title {
    font-size: 2.25rem;
    font-weight: 800;
    letter-spacing: -0.03em;
    line-height: 1.2;
    margin-bottom: var(--space-3);
  }
  .lesson-header__emoji {
    margin-right: 0.25em;
  }
  .lesson-header__description {
    font-size: 1.15rem;
    color: var(--color-text-secondary, #6B6B6B);
    line-height: 1.6;
  }

  .notion-empty-state {
    text-align: center;
    padding: var(--space-12) 0;
    color: var(--color-text-secondary, #6B6B6B);
    font-style: italic;
  }
</style>
